(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))s(c);new MutationObserver(c=>{for(const d of c)if(d.type==="childList")for(const e of d.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&s(e)}).observe(document,{childList:!0,subtree:!0});function g(c){const d={};return c.integrity&&(d.integrity=c.integrity),c.referrerPolicy&&(d.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?d.credentials="include":c.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function s(c){if(c.ep)return;c.ep=!0;const d=g(c);fetch(c.href,d)}})();const R=navigator.userAgent.match(/iPhone|iPad|iPod/i);function T(y){const n=this;this.object=y,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation=null,this.screenOrientation=0,this.alphaOffset=0,this.initialOffset=null;const g=function({alpha:e,beta:l,gamma:v,webkitCompassHeading:p}){if(R){const w=360-p;n.alphaOffset=THREE.MathUtils.degToRad(w-e),n.deviceOrientation={alpha:e,beta:l,gamma:v,webkitCompassHeading:p}}else e<0&&(e+=360),n.deviceOrientation={alpha:e,beta:l,gamma:v};window.dispatchEvent(new CustomEvent("camera-rotation-change",{detail:{cameraRotation:y.rotation}}))},s=function(){n.screenOrientation=window.orientation||0},c=(function(){window.addEventListener("orientationchange",s,!1),R?window.addEventListener("deviceorientation",g,!1):window.addEventListener("deviceorientationabsolute",g,!1)}).bind(this),d=function(){const e=new THREE.Vector3(0,0,1),l=new THREE.Euler,v=new THREE.Quaternion,p=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(w,h,b,M,H){l.set(b,h,-M,"YXZ"),w.setFromEuler(l),w.multiply(p),w.multiply(v.setFromAxisAngle(e,-H))}}();this.connect=function(){s(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(function(e){e=="granted"&&c()}).catch(function(e){console.error("THREE.AbsoluteDeviceOrientationControls: Unable to use DeviceOrientation API:",e)}):c(),n.enabled=!0},this.disconnect=function(){R?(window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",g,!1)):(window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientationabsolute",g,!1)),n.enabled=!1,n.initialOffset=!1,n.deviceOrientation=null},this.update=function({theta:e=0}={theta:0}){if(n.enabled===!1)return;const l=n.deviceOrientation;if(l){const v=l.alpha?THREE.MathUtils.degToRad(l.alpha):0,p=l.beta?THREE.MathUtils.degToRad(l.beta):0,w=l.gamma?THREE.MathUtils.degToRad(l.gamma):0,h=n.screenOrientation?THREE.MathUtils.degToRad(n.screenOrientation):0;if(R){const b=new THREE.Quaternion;d(b,v,p,w,h);const M=new THREE.Euler().setFromQuaternion(b,"YXZ");console.log(M.x,M.y,M.z),M.y=THREE.MathUtils.degToRad(360-l.webkitCompassHeading),b.setFromEuler(M),n.object.quaternion.copy(b)}else d(n.object.quaternion,v+e,p,w,h)}},this.updateAlphaOffset=function(){n.initialOffset=!1},this.dispose=function(){n.disconnect()},this.getAlpha=function(){const{deviceOrientation:e}=n;return e&&e.alpha?THREE.MathUtils.degToRad(e.alpha)+n.alphaOffset:0},this.getBeta=function(){const{deviceOrientation:e}=n;return e&&e.beta?THREE.MathUtils.degToRad(e.beta):0},this.getGamma=function(){const{deviceOrientation:e}=n;return e&&e.gamma?THREE.MathUtils.degToRad(e.gamma):0},this.connect()}T.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:T});window.onload=()=>{let y=!1,n=null;const g={latitude:51.935175,longitude:7.649708},s={latitude:null,longitude:null},c=[3,5.5,12],d=document.querySelector("a-scene"),e=document.querySelector("[gps-new-camera]");e.setAttribute("camera",{far:100});const l=document.createElement("div");l.id="distanceDisplay",document.body.appendChild(l);const v=document.createElement("div");v.id="compassContainer",document.body.appendChild(v);const p=document.createElement("div");p.id="compassArrow",p.innerText="↑",v.appendChild(p);const w=document.createElement("div");w.id="compassText",v.appendChild(w);const h=new T(e.object3D);window.addEventListener("camera-rotation-change",a=>{h.update(),T.isIOS&&h.deviceOrientation&&n===null&&(n=h.deviceOrientation.webkitCompassHeading||0,console.log("Initialer absoluter Kompasswert (true heading) gesetzt:",n));let r=b();w.innerText=`${Math.round(r)}°`,p.style.transform=`rotate(${-r}deg)`,s.latitude!==null&&s.longitude!==null&&M(T.isIOS&&h.deviceOrientation?h.deviceOrientation.webkitCompassHeading:q(h.object.quaternion).yaw,s.latitude,s.longitude,g.latitude,g.longitude)});function b(){if(T.isIOS&&h.deviceOrientation)return h.deviceOrientation.webkitCompassHeading||0;{const a=h.object.quaternion,r=new THREE.Euler().setFromQuaternion(a,"YXZ");let t=THREE.MathUtils.radToDeg(r.y);return t=Math.abs((t-360)%360),t}}e.addEventListener("gps-camera-update-position",a=>{if(s.latitude=a.detail.position.latitude,s.longitude=a.detail.position.longitude,s.latitude&&s.longitude){const r=L(s.latitude,s.longitude,g.latitude,g.longitude);l.innerText=`Entfernung zum Ziel: ${Math.round(r)} m`;const t=P(s.latitude,s.longitude,g.latitude,g.longitude);let u=t;if(T.isIOS&&h.deviceOrientation&&n!==null){const o=((h.deviceOrientation.webkitCompassHeading||0)-n+360)%360;u=(t-o+360)%360,console.log("originalBearing:",t,"relativeRotation:",o,"=> arBearing:",u)}if(document.querySelectorAll("a-sphere").forEach(i=>i.remove()),c.forEach((i,o)=>{const f=document.createElement("a-sphere");f.setAttribute("color","#00008B"),f.setAttribute("opacity","0.7");const E=I(s.latitude,s.longitude,i,u);f.setAttribute("gps-new-entity-place",{latitude:E.latitude,longitude:E.longitude});let m;o===0?m=.3:o===1?m=.4:o===2&&(m=.65),f.setAttribute("radius",m.toString()),d.appendChild(f)}),!y){const i=document.createElement("a-image");i.setAttribute("src","./images/map-marker.png"),i.setAttribute("width","4"),i.setAttribute("height","4"),i.setAttribute("look-at","[gps-new-camera]"),i.setAttribute("gps-new-entity-place",{latitude:g.latitude,longitude:g.longitude}),d.appendChild(i),y=!0}}else console.error("Keine aktuellen Koordinaten vorhanden!"),D("Keine aktuellen Koordinaten vorhanden!")});function M(a,r,t,u,i){const o=P(u,i,r,t);S(a,o)<15?H():p.style.color="red"}function H(){p.style.color="green"}function I(a,r,t,u){const i=Math.PI/180,o=6371e3,f=u*i,E=a*i,m=r*i,O=Math.asin(Math.sin(E)*Math.cos(t/o)+Math.cos(E)*Math.sin(t/o)*Math.cos(f)),A=m+Math.atan2(Math.sin(f)*Math.sin(t/o)*Math.cos(E),Math.cos(t/o)-Math.sin(E)*Math.sin(O));return{latitude:O/i,longitude:A/i}}function L(a,r,t,u){const o=Math.PI/180,f=(t-a)*o,E=(u-r)*o,m=Math.sin(f/2)**2+Math.cos(a*o)*Math.cos(t*o)*Math.sin(E/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))}function D(a){alert(a)}function P(a,r,t,u){const i=a*Math.PI/180,o=t*Math.PI/180,f=(u-r)*Math.PI/180,E=Math.sin(f)*Math.cos(o),m=Math.cos(i)*Math.sin(o)-Math.sin(i)*Math.cos(o)*Math.cos(f);return(Math.atan2(E,m)*180/Math.PI+360)%360}function q(a){const r=a.x,t=a.y,u=a.z,i=a.w,o=2*(i*r+t*u),f=1-2*(r*r+t*t),E=Math.atan2(o,f),m=2*(i*t-u*r);let O;Math.abs(m)>=1?O=Math.sign(m)*Math.PI/2:O=Math.asin(m);const A=2*(i*u+r*t),U=1-2*(t*t+u*u);let C=Math.atan2(A,U)*180/Math.PI;return C<0&&(C+=360),{roll:E*180/Math.PI,pitch:O*180/Math.PI,yaw:C}}function S(a,r){let t=Math.abs(a-r)%360;return t>180&&(t=360-t),t}};
