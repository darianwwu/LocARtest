(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const b=navigator.userAgent.match(/iPhone|iPad|iPod/i);function M(s){const e=this;this.object=s,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation=null,this.screenOrientation=0,this.alphaOffset=0,this.initialOffset=null;const t=function({alpha:n,beta:r,gamma:c,webkitCompassHeading:d}){if(b){const u=360-d;e.alphaOffset=THREE.MathUtils.degToRad(u-n),e.deviceOrientation={alpha:n,beta:r,gamma:c,webkitCompassHeading:d}}else n<0&&(n+=360),e.deviceOrientation={alpha:n,beta:r,gamma:c};window.dispatchEvent(new CustomEvent("camera-rotation-change",{detail:{cameraRotation:s.rotation}}))},a=function(){e.screenOrientation=window.orientation||0},o=(function(){window.addEventListener("orientationchange",a,!1),b?window.addEventListener("deviceorientation",t,!1):window.addEventListener("deviceorientationabsolute",t,!1)}).bind(this),i=function(){const n=new THREE.Vector3(0,0,1),r=new THREE.Euler,c=new THREE.Quaternion,d=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(u,v,f,m,P){r.set(f,v,-m,"YXZ"),u.setFromEuler(r),u.multiply(d),u.multiply(c.setFromAxisAngle(n,-P))}}();this.connect=function(){a(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(function(n){n=="granted"&&o()}).catch(function(n){console.error("THREE.AbsoluteDeviceOrientationControls: Unable to use DeviceOrientation API:",n)}):o(),e.enabled=!0},this.disconnect=function(){b?(window.removeEventListener("orientationchange",a,!1),window.removeEventListener("deviceorientation",t,!1)):(window.removeEventListener("orientationchange",a,!1),window.removeEventListener("deviceorientationabsolute",t,!1)),e.enabled=!1,e.initialOffset=!1,e.deviceOrientation=null},this.update=function({theta:n=0}={theta:0}){if(e.enabled===!1)return;const r=e.deviceOrientation;if(r){const c=r.alpha?THREE.MathUtils.degToRad(r.alpha):0,d=r.beta?THREE.MathUtils.degToRad(r.beta):0,u=r.gamma?THREE.MathUtils.degToRad(r.gamma):0,v=e.screenOrientation?THREE.MathUtils.degToRad(e.screenOrientation):0;if(b){const f=new THREE.Quaternion;i(f,c,d,u,v);const m=new THREE.Euler().setFromQuaternion(f,"YXZ");console.log(m.x,m.y,m.z),m.y=THREE.MathUtils.degToRad(360-r.webkitCompassHeading),f.setFromEuler(m),e.object.quaternion.copy(f)}else i(e.object.quaternion,c+n,d,u,v)}},this.updateAlphaOffset=function(){e.initialOffset=!1},this.dispose=function(){e.disconnect()},this.getAlpha=function(){const{deviceOrientation:n}=e;return n&&n.alpha?THREE.MathUtils.degToRad(n.alpha)+e.alphaOffset:0},this.getBeta=function(){const{deviceOrientation:n}=e;return n&&n.beta?THREE.MathUtils.degToRad(n.beta):0},this.getGamma=function(){const{deviceOrientation:n}=e;return n&&n.gamma?THREE.MathUtils.degToRad(n.gamma):0},this.connect()}M.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:M});var R,E,h,l,I,H,y,O,w,p,T,g;window.onload=s=>{console.log("page loaded, proceed to init");const e=document.getElementById("overlay"),t=document.getElementById("btnStart"),a=document.getElementById("app");t.addEventListener("click",function(o){C(),document.body.removeChild(e),a.style.display="block"})};function C(){console.log("init function called"),H=document.querySelector("a-scene"),y=document.querySelector("[gps-new-camera]"),y.setAttribute("camera",{far:100}),O=document.createElement("div"),O.id="distanceDisplay",document.body.appendChild(O),w=document.createElement("div"),w.id="compassContainer",document.body.appendChild(w),p=document.createElement("div"),p.id="compassArrow",p.innerText="↑",w.appendChild(p),T=document.createElement("div"),T.id="compassText",w.appendChild(T),g=new M(y.object3D),I=[3,5.5,12],l={latitude:null,longitude:null},h={latitude:51.935175,longitude:7.649708},R=!1,E=null,window.addEventListener("camera-rotation-change",s=>{g.update();let e=L();if(T.innerText=`${Math.round(e)}°`,p.style.transform=`rotate(${-e}deg)`,M.isIOS&&E===null&&g.deviceOrientation){const t=S(g.object.quaternion);E=(g.deviceOrientation.webkitCompassHeading||0)-t,console.log("Kalibrierungs-Offset gesetzt:",E)}l.latitude!==null&&l.longitude!==null&&q(g.object.quaternion,l.latitude,l.longitude,h.latitude,h.longitude)}),y.addEventListener("gps-camera-update-position",s=>{if(l.latitude=s.detail.position.latitude,l.longitude=s.detail.position.longitude,l.latitude&&l.longitude){const e=U(l.latitude,l.longitude,h.latitude,h.longitude);O.innerText=`Entfernung zum Ziel: ${Math.round(e)} m`;let t;if(M.isIOS&&E!==null?t=(A(l.latitude,l.longitude,h.latitude,h.longitude)+E+360)%360:t=A(l.latitude,l.longitude,h.latitude,h.longitude),document.querySelectorAll("a-sphere").forEach(a=>a.remove()),I.forEach((a,o)=>{const i=document.createElement("a-sphere");i.setAttribute("color","#00008B"),i.setAttribute("opacity","0.7");const n=B(l.latitude,l.longitude,a,t);i.setAttribute("gps-new-entity-place",{latitude:n.latitude,longitude:n.longitude});let r;o===0?r=.3:o===1?r=.4:o===2&&(r=.65),i.setAttribute("radius",r.toString()),H.appendChild(i)}),!R){const a=document.createElement("a-image");a.setAttribute("src","./images/map-marker.png"),a.setAttribute("width","4"),a.setAttribute("height","4"),a.setAttribute("look-at","[gps-new-camera]"),a.setAttribute("gps-new-entity-place",{latitude:h.latitude,longitude:h.longitude}),H.appendChild(a),R=!0}}else console.error("Keine aktuellen Koordinaten vorhanden!"),j("Keine aktuellen Koordinaten vorhanden!")})}function L(){if(M.isIOS&&g.deviceOrientation)return g.deviceOrientation.webkitCompassHeading||0;{const s=g.object.quaternion,e=new THREE.Euler().setFromQuaternion(s,"YXZ");let t=THREE.MathUtils.radToDeg(e.y);return t=Math.abs((t-360)%360),t}}function q(s,e,t,a,o){const i=A(a,o,e,t),r=x(s).yaw;k(r,i)<15?D():p.style.color="red"}function D(){p.style.color="green"}function S(s){const{x:e,y:t,z:a,w:o}=s;let i=Math.atan2(2*(o*a+e*t),1-2*(t*t+a*a))*180/Math.PI;return i<0&&(i+=360),i}function B(s,e,t,a){const o=Math.PI/180,i=6371e3,n=a*o,r=s*o,c=e*o,d=Math.asin(Math.sin(r)*Math.cos(t/i)+Math.cos(r)*Math.sin(t/i)*Math.cos(n)),u=c+Math.atan2(Math.sin(n)*Math.sin(t/i)*Math.cos(r),Math.cos(t/i)-Math.sin(r)*Math.sin(d));return{latitude:d/o,longitude:u/o}}function U(s,e,t,a){const i=Math.PI/180,n=(t-s)*i,r=(a-e)*i,c=Math.sin(n/2)**2+Math.cos(s*i)*Math.cos(t*i)*Math.sin(r/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function j(s){alert(s)}function A(s,e,t,a){const o=s*Math.PI/180,i=t*Math.PI/180,n=(a-e)*Math.PI/180,r=Math.sin(n)*Math.cos(i),c=Math.cos(o)*Math.sin(i)-Math.sin(o)*Math.cos(i)*Math.cos(n);return(Math.atan2(r,c)*180/Math.PI+360)%360}function x(s){const e=s.x,t=s.y,a=s.z,o=s.w,i=2*(o*e+t*a),n=1-2*(e*e+t*t),r=Math.atan2(i,n),c=2*(o*t-a*e);let d;Math.abs(c)>=1?d=Math.sign(c)*Math.PI/2:d=Math.asin(c);const u=2*(o*a+e*t),v=1-2*(t*t+a*a);let f=Math.atan2(u,v)*180/Math.PI;return f<0&&(f+=360),{roll:r*180/Math.PI,pitch:d*180/Math.PI,yaw:f}}function k(s,e){let t=Math.abs(s-e)%360;return t>180&&(t=360-t),t}
